{
  RemoteOperationResult result=null;
  boolean localCopyPassed=false, nameCheckPassed=false;
  String originalStoragePath=mFile.getStoragePath();
  File temporalFile=null, originalFile=new File(originalStoragePath), expectedFile=null;
  try {
    if (!mForceOverwrite) {
      String remotePath=getAvailableRemotePath(client,mRemotePath);
      mWasRenamed=!remotePath.equals(mRemotePath);
      if (mWasRenamed) {
        createNewOCFile(remotePath);
      }
    }
    nameCheckPassed=true;
    String expectedPath=FileStorageUtils.getDefaultSavePathFor(mAccount.name,mFile);
    expectedFile=new File(expectedPath);
    if (!originalStoragePath.equals(expectedPath) && mLocalBehaviour == FileUploader.LOCAL_BEHAVIOUR_COPY) {
      File ocLocalFolder=new File(FileStorageUtils.getSavePath(mAccount.name));
      if (ocLocalFolder.getUsableSpace() < originalFile.length()) {
        result=new RemoteOperationResult(ResultCode.LOCAL_STORAGE_FULL);
        return result;
      }
 else {
        String temporalPath=FileStorageUtils.getTemporalPath(mAccount.name) + mFile.getRemotePath();
        mFile.setStoragePath(temporalPath);
        temporalFile=new File(temporalPath);
        if (!originalStoragePath.equals(temporalPath)) {
          InputStream in=new FileInputStream(originalFile);
          OutputStream out=new FileOutputStream(temporalFile);
          byte[] buf=new byte[1024];
          int len;
          while ((len=in.read(buf)) > 0) {
            out.write(buf,0,len);
          }
          in.close();
          out.close();
        }
      }
    }
    localCopyPassed=true;
synchronized (mCancellationRequested) {
      if (mCancellationRequested.get()) {
        throw new OperationCancelledException();
      }
 else {
        mPutMethod=new PutMethod(client.getBaseUri() + WebdavUtils.encodePath(mFile.getRemotePath()));
      }
    }
    int status=uploadFile(client);
    if (isSuccess(status)) {
      if (mLocalBehaviour == FileUploader.LOCAL_BEHAVIOUR_FORGET) {
        mFile.setStoragePath(null);
      }
 else {
        mFile.setStoragePath(expectedPath);
        File fileToMove=null;
        if (temporalFile != null) {
          fileToMove=temporalFile;
        }
 else {
          fileToMove=originalFile;
        }
        expectedFile=new File(mFile.getStoragePath());
        if (!expectedFile.equals(fileToMove) && !fileToMove.renameTo(expectedFile)) {
          result=new RemoteOperationResult(ResultCode.LOCAL_STORAGE_NOT_MOVED);
          return result;
        }
      }
    }
    result=new RemoteOperationResult(isSuccess(status),status);
  }
 catch (  Exception e) {
    if (mCancellationRequested.get()) {
      result=new RemoteOperationResult(new OperationCancelledException());
    }
 else {
      result=new RemoteOperationResult(e);
    }
  }
 finally {
    if (temporalFile != null && !originalFile.equals(temporalFile)) {
      temporalFile.delete();
    }
    if (result.isSuccess()) {
      Log.i(TAG,"Upload of " + originalStoragePath + " to "+ mRemotePath+ ": "+ result.getLogMessage());
    }
 else {
      if (result.getException() != null) {
        String complement="";
        if (!nameCheckPassed) {
          complement=" (while checking file existence in server)";
        }
 else         if (!localCopyPassed) {
          complement=" (while copying local file to " + FileStorageUtils.getSavePath(mAccount.name) + ")";
        }
        Log.e(TAG,"Upload of " + originalStoragePath + " to "+ mRemotePath+ ": "+ result.getLogMessage()+ complement,result.getException());
      }
 else {
        Log.e(TAG,"Upload of " + originalStoragePath + " to "+ mRemotePath+ ": "+ result.getLogMessage());
      }
    }
  }
  return result;
}
