{
  View view=convertView;
  if (view == null) {
    LayoutInflater inflator=(LayoutInflater)mParentActivity.getSystemService(Context.LAYOUT_INFLATER_SERVICE);
    view=inflator.inflate(R.layout.upload_list_item,null);
  }
  if (uploadsItems != null && uploadsItems.length > position) {
    final OCUpload upload=uploadsItems[position];
    TextView fileTextView=(TextView)view.findViewById(R.id.upload_name);
    File localFile=new File(upload.getLocalPath());
    String fileName=localFile.getName();
    if (fileName.length() == 0) {
      fileName=File.separator;
    }
    fileTextView.setText(fileName);
    TextView pathTextView=(TextView)view.findViewById(R.id.upload_local_path);
    String remoteParentPath=upload.getRemotePath();
    remoteParentPath=new File(remoteParentPath).getParent();
    pathTextView.setText(mParentActivity.getString(R.string.app_name) + remoteParentPath);
    TextView fileSizeTextView=(TextView)view.findViewById(R.id.upload_file_size);
    fileSizeTextView.setText(DisplayUtils.bytesToHumanReadable(localFile.length()) + ", ");
    TextView uploadDateTextView=(TextView)view.findViewById(R.id.upload_date);
    long updateTime=(new File(upload.getLocalPath())).lastModified();
    CharSequence dateString=DisplayUtils.getRelativeDateTimeString(mParentActivity,updateTime,DateUtils.SECOND_IN_MILLIS,DateUtils.WEEK_IN_MILLIS,0);
    uploadDateTextView.setText(dateString);
    TextView accountNameTextView=(TextView)view.findViewById(R.id.upload_account);
    accountNameTextView.setText(upload.getAccountName());
    TextView statusTextView=(TextView)view.findViewById(R.id.upload_status);
    String status;
    uploadDateTextView.setVisibility(View.VISIBLE);
    pathTextView.setVisibility(View.VISIBLE);
    fileSizeTextView.setVisibility(View.VISIBLE);
    accountNameTextView.setVisibility(View.VISIBLE);
    statusTextView.setVisibility(View.VISIBLE);
switch (upload.getUploadStatus()) {
case UPLOAD_IN_PROGRESS:
      status=mParentActivity.getString(R.string.uploader_upload_in_progress_ticker);
    ProgressBar progressBar=(ProgressBar)view.findViewById(R.id.upload_progress_bar);
  progressBar.setProgress(0);
progressBar.setVisibility(View.VISIBLE);
mProgressListener=new ProgressListener(progressBar);
if (mParentActivity.getFileUploaderBinder() != null) {
mParentActivity.getFileUploaderBinder().addDatatransferProgressListener(mProgressListener,mParentActivity.getAccount(),upload);
}
 else {
Log_OC.e(TAG,"UploadBinder == null. It should have been created on creating mParentActivity" + " which inherits from FileActivity. Fix that!");
Log_OC.e(TAG,"PENDING BINDING for upload = " + upload.getLocalPath());
}
uploadDateTextView.setVisibility(View.GONE);
pathTextView.setVisibility(View.GONE);
fileSizeTextView.setVisibility(View.GONE);
accountNameTextView.setVisibility(View.INVISIBLE);
break;
case UPLOAD_FAILED:
uploadDateTextView.setVisibility(View.GONE);
if (upload.getLastResult() != null) {
switch (upload.getLastResult()) {
case CREDENTIAL_ERROR:
status=mParentActivity.getString(R.string.uploads_view_upload_status_failed_credentials_error);
view.setOnClickListener(new OnClickListener(){
@Override public void onClick(View v){
Intent updateAccountCredentials=new Intent(mParentActivity,AuthenticatorActivity.class);
updateAccountCredentials.putExtra(AuthenticatorActivity.EXTRA_ACCOUNT,upload.getAccount(mParentActivity));
updateAccountCredentials.putExtra(AuthenticatorActivity.EXTRA_ACTION,AuthenticatorActivity.ACTION_UPDATE_EXPIRED_TOKEN);
updateAccountCredentials.addFlags(Intent.FLAG_ACTIVITY_EXCLUDE_FROM_RECENTS);
updateAccountCredentials.addFlags(Intent.FLAG_FROM_BACKGROUND);
mParentActivity.startActivity(updateAccountCredentials);
}
}
);
break;
case FOLDER_ERROR:
status=mParentActivity.getString(R.string.uploads_view_upload_status_failed_folder_error);
break;
case FILE_ERROR:
status=mParentActivity.getString(R.string.uploads_view_upload_status_failed_file_error);
break;
case PRIVILEDGES_ERROR:
status=mParentActivity.getString(R.string.uploads_view_upload_status_failed_permission_error);
break;
case NETWORK_CONNECTION:
status=mParentActivity.getString(R.string.uploads_view_upload_status_failed_connection_error);
break;
default :
status=mParentActivity.getString(R.string.uploads_view_upload_status_failed) + ": " + upload.getLastResult().toString();
break;
}
}
 else {
status=mParentActivity.getString(R.string.uploads_view_upload_status_failed);
;
}
String laterReason=upload.getUploadLaterReason(mParentActivity);
if (laterReason != null) {
status=laterReason;
}
break;
case UPLOAD_SUCCEEDED:
status=mParentActivity.getString(R.string.uploads_view_upload_status_succeeded);
statusTextView.setVisibility(View.GONE);
break;
default :
status=upload.getUploadStatus().toString();
if (upload.getLastResult() != null) {
upload.getLastResult().toString();
}
break;
}
if (upload.getUploadStatus() != UploadStatus.UPLOAD_IN_PROGRESS) {
ProgressBar progressBar=(ProgressBar)view.findViewById(R.id.upload_progress_bar);
progressBar.setVisibility(View.GONE);
if (mParentActivity.getFileUploaderBinder() != null && mProgressListener != null) {
mParentActivity.getFileUploaderBinder().removeDatatransferProgressListener(mProgressListener,upload.getAccount(mParentActivity),upload);
mProgressListener=null;
}
}
statusTextView.setText(status);
ImageButton rightButton=(ImageButton)view.findViewById(R.id.upload_right_button);
if (upload.userCanCancelUpload()) {
rightButton.setImageResource(R.drawable.ic_cancel);
rightButton.setOnClickListener(new OnClickListener(){
@Override public void onClick(View v){
FileUploader.FileUploaderBinder uploaderBinder=mParentActivity.getFileUploaderBinder();
if (uploaderBinder != null) {
uploaderBinder.cancel(upload);
refreshView();
}
}
}
);
}
 else {
rightButton.setImageResource(R.drawable.ic_delete);
rightButton.setOnClickListener(new OnClickListener(){
@Override public void onClick(View v){
mUploadsStorageManager.removeUpload(upload);
refreshView();
}
}
);
}
if (upload.userCanRetryUpload()) {
view.setOnClickListener(new OnClickListener(){
@Override public void onClick(View v){
mParentActivity.getFileOperationsHelper().retryUpload(upload);
}
}
);
}
ImageView fileIcon=(ImageView)view.findViewById(R.id.thumbnail);
fileIcon.setImageResource(R.drawable.file);
OCFile fakeFileToCheatThumbnailsCacheManagerInterface=new OCFile(upload.getRemotePath());
fakeFileToCheatThumbnailsCacheManagerInterface.setStoragePath(upload.getLocalPath());
fakeFileToCheatThumbnailsCacheManagerInterface.setMimetype(upload.getMimeType());
boolean allowedToCreateNewThumbnail=(ThumbnailsCacheManager.cancelPotentialWork(fakeFileToCheatThumbnailsCacheManagerInterface,fileIcon));
if ((fakeFileToCheatThumbnailsCacheManagerInterface.isImage() && fakeFileToCheatThumbnailsCacheManagerInterface.getRemoteId() != null && upload.getUploadStatus() == UploadStatus.UPLOAD_SUCCEEDED)) {
Bitmap thumbnail=ThumbnailsCacheManager.getBitmapFromDiskCache(String.valueOf(fakeFileToCheatThumbnailsCacheManagerInterface.getRemoteId()));
if (thumbnail != null && !fakeFileToCheatThumbnailsCacheManagerInterface.needsUpdateThumbnail()) {
fileIcon.setImageBitmap(thumbnail);
}
 else {
if (allowedToCreateNewThumbnail) {
final ThumbnailsCacheManager.ThumbnailGenerationTask task=new ThumbnailsCacheManager.ThumbnailGenerationTask(fileIcon,mParentActivity.getStorageManager(),mParentActivity.getAccount());
if (thumbnail == null) {
thumbnail=ThumbnailsCacheManager.mDefaultImg;
}
final ThumbnailsCacheManager.AsyncDrawable asyncDrawable=new ThumbnailsCacheManager.AsyncDrawable(mParentActivity.getResources(),thumbnail,task);
fileIcon.setImageDrawable(asyncDrawable);
task.execute(fakeFileToCheatThumbnailsCacheManagerInterface);
}
}
if ("image/png".equals(upload.getMimeType())) {
fileIcon.setBackgroundColor(mParentActivity.getResources().getColor(R.color.background_color));
}
}
 else if (fakeFileToCheatThumbnailsCacheManagerInterface.isImage()) {
File file=new File(upload.getLocalPath());
Bitmap thumbnail=ThumbnailsCacheManager.getBitmapFromDiskCache(String.valueOf(file.hashCode()));
if (thumbnail != null) {
fileIcon.setImageBitmap(thumbnail);
}
 else {
if (allowedToCreateNewThumbnail) {
final ThumbnailsCacheManager.ThumbnailGenerationTask task=new ThumbnailsCacheManager.ThumbnailGenerationTask(fileIcon);
if (thumbnail == null) {
thumbnail=ThumbnailsCacheManager.mDefaultImg;
}
final ThumbnailsCacheManager.AsyncDrawable asyncDrawable=new ThumbnailsCacheManager.AsyncDrawable(mParentActivity.getResources(),thumbnail,task);
fileIcon.setImageDrawable(asyncDrawable);
task.execute(file);
Log_OC.v(TAG,"Executing task to generate a new thumbnail");
}
}
if ("image/png".equalsIgnoreCase(upload.getMimeType())) {
fileIcon.setBackgroundColor(mParentActivity.getResources().getColor(R.color.background_color));
}
}
 else {
fileIcon.setImageResource(MimetypeIconUtil.getFileTypeIconId(upload.getMimeType(),fileName));
}
}
return view;
}
