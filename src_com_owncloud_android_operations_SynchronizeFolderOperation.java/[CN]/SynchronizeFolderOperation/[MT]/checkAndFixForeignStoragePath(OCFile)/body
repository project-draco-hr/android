{
  String storagePath=file.getStoragePath();
  String expectedPath=FileStorageUtils.getDefaultSavePathFor(mAccount.name,file);
  if (storagePath != null && !storagePath.equals(expectedPath)) {
    File originalFile=new File(storagePath);
    if (FileStorageUtils.getUsableSpace(mAccount.name) < originalFile.length()) {
      mForgottenLocalFiles.put(file.getRemotePath(),storagePath);
      file.setStoragePath(null);
    }
 else {
      InputStream in=null;
      OutputStream out=null;
      try {
        File expectedFile=new File(expectedPath);
        File expectedParent=expectedFile.getParentFile();
        expectedParent.mkdirs();
        if (!expectedParent.isDirectory()) {
          throw new IOException("Unexpected error: parent directory could not be created");
        }
        expectedFile.createNewFile();
        if (!expectedFile.isFile()) {
          throw new IOException("Unexpected error: target file could not be created");
        }
        in=new FileInputStream(originalFile);
        out=new FileOutputStream(expectedFile);
        byte[] buf=new byte[1024];
        int len;
        while ((len=in.read(buf)) > 0) {
          out.write(buf,0,len);
        }
        file.setStoragePath(expectedPath);
      }
 catch (      Exception e) {
        Log.e(TAG,"Exception while copying foreign file " + expectedPath,e);
        mForgottenLocalFiles.put(file.getRemotePath(),storagePath);
        file.setStoragePath(null);
      }
 finally {
        try {
          if (in != null)           in.close();
        }
 catch (        Exception e) {
          Log.d(TAG,"Weird exception while closing input stream for " + storagePath + " (ignoring)",e);
        }
        try {
          if (out != null)           out.close();
        }
 catch (        Exception e) {
          Log.d(TAG,"Weird exception while closing output stream for " + expectedPath + " (ignoring)",e);
        }
      }
    }
  }
}
