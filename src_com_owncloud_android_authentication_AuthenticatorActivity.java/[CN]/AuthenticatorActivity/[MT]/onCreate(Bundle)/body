{
  super.onCreate(savedInstanceState);
  getWindow().requestFeature(Window.FEATURE_NO_TITLE);
  mOperationsConnection=new ServiceConnection(){
    @Override public void onServiceConnected(    ComponentName name,    IBinder service){
      Log_OC.d(TAG,"Operations service connected");
      mOperationsBinder=(OperationsServiceBinder)service;
    }
    @Override public void onServiceDisconnected(    ComponentName name){
      Log_OC.d(TAG,"Operations service crashed");
      mOperationsBinder=null;
    }
  }
;
  if (!bindService(new Intent(this,OperationsService.class),mOperationsConnection,Context.BIND_AUTO_CREATE)) {
    Toast.makeText(this,R.string.error_cant_bind_to_operations_service,Toast.LENGTH_LONG).show();
    finish();
  }
  setContentView(R.layout.account_setup);
  mAuthMessage=(TextView)findViewById(R.id.auth_message);
  mHostUrlInput=(EditText)findViewById(R.id.hostUrlInput);
  mHostUrlInput.setText(getString(R.string.server_url));
  mUsernameInput=(EditText)findViewById(R.id.account_username);
  mPasswordInput=(EditText)findViewById(R.id.account_password);
  mOAuthAuthEndpointText=(TextView)findViewById(R.id.oAuthEntryPoint_1);
  mOAuthTokenEndpointText=(TextView)findViewById(R.id.oAuthEntryPoint_2);
  mOAuth2Check=(CheckBox)findViewById(R.id.oauth_onOff_check);
  mOkButton=findViewById(R.id.buttonOK);
  mAuthStatusLayout=(TextView)findViewById(R.id.auth_status_text);
  mHostUrlInputEnabled=getResources().getBoolean(R.bool.show_server_url_input);
  boolean accountRegisterVisibility=getResources().getBoolean(R.bool.show_welcome_link);
  Button welcomeLink=(Button)findViewById(R.id.welcome_link);
  if (welcomeLink != null) {
    if (accountRegisterVisibility) {
      welcomeLink.setVisibility(View.VISIBLE);
      welcomeLink.setText(String.format(getString(R.string.auth_register),getString(R.string.app_name)));
    }
 else {
      findViewById(R.id.welcome_link).setVisibility(View.GONE);
    }
  }
  mAccountMgr=AccountManager.get(this);
  mNewCapturedUriFromOAuth2Redirection=null;
  mAction=getIntent().getByteExtra(EXTRA_ACTION,ACTION_CREATE);
  mAccount=null;
  mHostBaseUrl="";
  boolean refreshButtonEnabled=false;
  if (!mHostUrlInputEnabled) {
    findViewById(R.id.hostUrlFrame).setVisibility(View.GONE);
    mRefreshButton=findViewById(R.id.centeredRefreshButton);
  }
 else {
    mRefreshButton=findViewById(R.id.embeddedRefreshButton);
  }
  if (savedInstanceState == null) {
    mResumed=false;
    mAuthMessageVisibility=View.GONE;
    mServerStatusText=mServerStatusIcon=0;
    mServerIsValid=false;
    mServerIsChecked=false;
    mIsSslConn=false;
    mAuthStatusText=mAuthStatusIcon=0;
    mAccount=getIntent().getExtras().getParcelable(EXTRA_ACCOUNT);
    if (mAccount != null) {
      String ocVersion=mAccountMgr.getUserData(mAccount,Constants.KEY_OC_VERSION);
      String ocVersionString=mAccountMgr.getUserData(mAccount,Constants.KEY_OC_VERSION_STRING);
      if (ocVersion != null) {
        mDiscoveredVersion=new OwnCloudVersion(ocVersion,ocVersionString);
      }
      mHostBaseUrl=normalizeUrl(mAccountMgr.getUserData(mAccount,Constants.KEY_OC_BASE_URL));
      mHostUrlInput.setText(mHostBaseUrl);
      String userName=mAccount.name.substring(0,mAccount.name.lastIndexOf('@'));
      mUsernameInput.setText(userName);
    }
    initAuthorizationMethod();
    mJustCreated=true;
    if (mAction == ACTION_UPDATE_TOKEN || !mHostUrlInputEnabled) {
      checkOcServer();
    }
  }
 else {
    mResumed=true;
    mAuthMessageVisibility=savedInstanceState.getInt(KEY_AUTH_MESSAGE_VISIBILITY);
    mAuthMessageText=savedInstanceState.getString(KEY_AUTH_MESSAGE_TEXT);
    mServerIsValid=savedInstanceState.getBoolean(KEY_SERVER_VALID);
    mServerIsChecked=savedInstanceState.getBoolean(KEY_SERVER_CHECKED);
    mServerStatusText=savedInstanceState.getInt(KEY_SERVER_STATUS_TEXT);
    mServerStatusIcon=savedInstanceState.getInt(KEY_SERVER_STATUS_ICON);
    mIsSslConn=savedInstanceState.getBoolean(KEY_IS_SSL_CONN);
    mAuthStatusText=savedInstanceState.getInt(KEY_AUTH_STATUS_TEXT);
    mAuthStatusIcon=savedInstanceState.getInt(KEY_AUTH_STATUS_ICON);
    if (savedInstanceState.getBoolean(KEY_PASSWORD_VISIBLE,false)) {
      showPassword();
    }
    String ocVersion=savedInstanceState.getString(KEY_OC_VERSION);
    String ocVersionString=savedInstanceState.getString(KEY_OC_VERSION_STRING);
    if (ocVersion != null) {
      mDiscoveredVersion=new OwnCloudVersion(ocVersion,ocVersionString);
    }
    mHostBaseUrl=savedInstanceState.getString(KEY_HOST_URL_TEXT);
    mAccount=savedInstanceState.getParcelable(KEY_ACCOUNT);
    mAuthTokenType=savedInstanceState.getString(AccountAuthenticator.KEY_AUTH_TOKEN_TYPE);
    if (mAuthTokenType == null) {
      mAuthTokenType=AccountTypeUtils.getAuthTokenTypePass(MainApp.getAccountType());
    }
    if (savedInstanceState.getBoolean(KEY_SERVER_CHECK_IN_PROGRESS,false)) {
      checkOcServer();
    }
    refreshButtonEnabled=savedInstanceState.getBoolean(KEY_REFRESH_BUTTON_ENABLED);
  }
  if (mAuthMessageVisibility == View.VISIBLE) {
    showAuthMessage(mAuthMessageText);
  }
 else {
    hideAuthMessage();
  }
  adaptViewAccordingToAuthenticationMethod();
  showServerStatus();
  showAuthStatus();
  if (mAction == ACTION_UPDATE_TOKEN) {
    mHostUrlInput.setEnabled(false);
    mHostUrlInput.setFocusable(false);
    mUsernameInput.setEnabled(false);
    mUsernameInput.setFocusable(false);
    mOAuth2Check.setVisibility(View.GONE);
  }
  if (mServerIsChecked && !mServerIsValid && refreshButtonEnabled)   showRefreshButton();
  mOkButton.setEnabled(mServerIsValid);
  if (AccountTypeUtils.getAuthTokenTypeSamlSessionCookie(MainApp.getAccountType()).equals(mAuthTokenType) || !AUTH_OPTIONAL.equals(getString(R.string.auth_method_oauth2))) {
    mOAuth2Check.setVisibility(View.GONE);
  }
  mPasswordInput.setText("");
  mHostUrlInput.setOnFocusChangeListener(this);
  mHostUrlInput.setImeOptions(EditorInfo.IME_ACTION_NEXT);
  mHostUrlInput.setOnEditorActionListener(this);
  mHostUrlInput.addTextChangedListener(new TextWatcher(){
    @Override public void afterTextChanged(    Editable s){
      if (!mHostBaseUrl.equals(normalizeUrl(mHostUrlInput.getText().toString()))) {
        mOkButton.setEnabled(false);
      }
    }
    @Override public void beforeTextChanged(    CharSequence s,    int start,    int count,    int after){
    }
    @Override public void onTextChanged(    CharSequence s,    int start,    int before,    int count){
      if (!mResumed) {
        mAuthStatusIcon=0;
        mAuthStatusText=0;
        showAuthStatus();
      }
      mResumed=false;
    }
  }
);
  mPasswordInput.setOnFocusChangeListener(this);
  mPasswordInput.setImeOptions(EditorInfo.IME_ACTION_DONE);
  mPasswordInput.setOnEditorActionListener(this);
  mPasswordInput.setOnTouchListener(new RightDrawableOnTouchListener(){
    @Override public boolean onDrawableTouch(    final MotionEvent event){
      if (event.getAction() == MotionEvent.ACTION_UP) {
        AuthenticatorActivity.this.onViewPasswordClick();
      }
      return true;
    }
  }
);
  findViewById(R.id.scroll).setOnTouchListener(new OnTouchListener(){
    @Override public boolean onTouch(    View view,    MotionEvent event){
      if (event.getAction() == MotionEvent.ACTION_DOWN) {
        if (AccountTypeUtils.getAuthTokenTypeSamlSessionCookie(MainApp.getAccountType()).equals(mAuthTokenType) && mHostUrlInput.hasFocus()) {
          checkOcServer();
        }
      }
      return false;
    }
  }
);
  mOperationsServiceConnection=new OperationsServiceConnection();
  bindService(new Intent(this,OperationsService.class),mOperationsServiceConnection,Context.BIND_AUTO_CREATE);
}
