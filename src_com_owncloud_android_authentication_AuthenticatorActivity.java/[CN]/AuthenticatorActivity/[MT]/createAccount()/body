{
  boolean isOAuth=AccountTypeUtils.getAuthTokenTypeAccessToken(MainApp.getAccountType()).equals(mAuthTokenType);
  boolean isSaml=AccountTypeUtils.getAuthTokenTypeSamlSessionCookie(MainApp.getAccountType()).equals(mAuthTokenType);
  Uri uri=Uri.parse(mHostBaseUrl);
  String username=mUsernameInput.getText().toString().trim();
  if (isSaml) {
    username=getUserNameForSaml();
    if (username == null)     return false;
  }
 else   if (isOAuth) {
    username="OAuth_user" + (new java.util.Random(System.currentTimeMillis())).nextLong();
  }
  String accountName=username + "@" + uri.getHost();
  if (uri.getPort() >= 0) {
    accountName+=":" + uri.getPort();
  }
  mAccount=new Account(accountName,MainApp.getAccountType());
  if (AccountUtils.exists(mAccount,getApplicationContext())) {
    RemoteOperationResult result=new RemoteOperationResult(ResultCode.ACCOUNT_NOT_NEW);
    updateAuthStatusIconAndText(result);
    showAuthStatus();
    Log_OC.d(TAG,result.getLogMessage());
    return false;
  }
 else {
    if (isOAuth || isSaml) {
      mAccountMgr.addAccountExplicitly(mAccount,"",null);
    }
 else {
      mAccountMgr.addAccountExplicitly(mAccount,mPasswordInput.getText().toString(),null);
    }
    Account defaultAccount=AccountUtils.getCurrentOwnCloudAccount(this);
    if (defaultAccount == null) {
      SharedPreferences.Editor editor=PreferenceManager.getDefaultSharedPreferences(this).edit();
      editor.putString("select_oc_account",accountName);
      editor.commit();
    }
    final Intent intent=new Intent();
    intent.putExtra(AccountManager.KEY_ACCOUNT_TYPE,MainApp.getAccountType());
    intent.putExtra(AccountManager.KEY_ACCOUNT_NAME,mAccount.name);
    intent.putExtra(AccountManager.KEY_USERDATA,username);
    if (isOAuth || isSaml) {
      mAccountMgr.setAuthToken(mAccount,mAuthTokenType,mAuthToken);
    }
    mAccountMgr.setUserData(mAccount,OwnCloudAccount.Constants.KEY_OC_VERSION,mDiscoveredVersion.toString());
    mAccountMgr.setUserData(mAccount,OwnCloudAccount.Constants.KEY_OC_BASE_URL,mHostBaseUrl);
    if (isSaml) {
      mAccountMgr.setUserData(mAccount,OwnCloudAccount.Constants.KEY_SUPPORTS_SAML_WEB_SSO,"TRUE");
    }
 else     if (isOAuth) {
      mAccountMgr.setUserData(mAccount,OwnCloudAccount.Constants.KEY_SUPPORTS_OAUTH2,"TRUE");
    }
    setAccountAuthenticatorResult(intent.getExtras());
    setResult(RESULT_OK,intent);
    return true;
  }
}
