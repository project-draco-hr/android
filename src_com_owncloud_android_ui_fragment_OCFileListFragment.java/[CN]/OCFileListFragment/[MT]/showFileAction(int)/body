{
  Bundle args=getArguments();
  PopupMenu pm=new PopupMenu(getActivity(),null);
  Menu menu=pm.getMenu();
  boolean allowContextualActions=(args == null) ? true : args.getBoolean(ARG_ALLOW_CONTEXTUAL_ACTIONS,true);
  if (allowContextualActions) {
    MenuInflater inflater=getActivity().getMenuInflater();
    inflater.inflate(R.menu.file_actions_menu,menu);
    OCFile targetFile=(OCFile)mAdapter.getItem(fileIndex);
    if (mContainerActivity.getStorageManager() != null) {
      FileMenuFilter mf=new FileMenuFilter(targetFile,mContainerActivity.getStorageManager().getAccount(),mContainerActivity,getActivity());
      mf.filter(menu);
    }
    MenuItem item=menu.findItem(R.id.action_open_file_with);
    FileFragment frag=((FileDisplayActivity)getActivity()).getSecondFragment();
    if (frag != null && frag instanceof FileDetailFragment && frag.getFile().getFileId() == targetFile.getFileId()) {
      item=menu.findItem(R.id.action_see_details);
      if (item != null) {
        item.setVisible(false);
        item.setEnabled(false);
      }
    }
    FileActionsDialogFragment dialog=FileActionsDialogFragment.newInstance(menu,fileIndex);
    dialog.setTargetFragment(this,0);
    dialog.show(getFragmentManager(),FileActionsDialogFragment.FTAG_FILE_ACTIONS);
  }
}
