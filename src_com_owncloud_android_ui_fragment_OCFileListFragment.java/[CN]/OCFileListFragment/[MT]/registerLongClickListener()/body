{
  getListView().setMultiChoiceModeListener(new AbsListView.MultiChoiceModeListener(){
    @Override public void onItemCheckedStateChanged(    ActionMode mode,    int position,    long id,    boolean checked){
      final int checkedCount=getListView().getCheckedItemCount();
      mode.setTitle(checkedCount + " Selected");
      if (checked) {
        mAdapter.setNewSelection(position,checked);
      }
 else {
        mAdapter.removeSelection(position);
      }
    }
    @Override public boolean onCreateActionMode(    ActionMode mode,    Menu menu){
      Bundle args=getArguments();
      boolean allowContextualActions=(args == null) ? true : args.getBoolean(ARG_ALLOW_CONTEXTUAL_ACTIONS,true);
      if (allowContextualActions) {
        MenuInflater inflater=getActivity().getMenuInflater();
        inflater.inflate(R.menu.file_actions_menu,menu);
        AdapterContextMenuInfo info=(AdapterContextMenuInfo)menuInfo;
        OCFile targetFile=(OCFile)mAdapter.getItem(info.position);
        if (mContainerActivity.getStorageManager() != null) {
          FileMenuFilter mf=new FileMenuFilter(targetFile,mContainerActivity.getStorageManager().getAccount(),mContainerActivity,getActivity());
          mf.filter(menu);
        }
        MenuItem item=menu.findItem(R.id.action_open_file_with);
        FileFragment frag=((FileDisplayActivity)getActivity()).getSecondFragment();
        if (frag != null && frag instanceof FileDetailFragment && frag.getFile().getFileId() == targetFile.getFileId()) {
          item=menu.findItem(R.id.action_see_details);
          if (item != null) {
            item.setVisible(false);
            item.setEnabled(false);
          }
        }
      }
      mode.getMenuInflater().inflate(R.menu.file_actions_menu,menu);
      return true;
    }
    @Override public boolean onPrepareActionMode(    ActionMode mode,    Menu menu){
      return false;
    }
    @Override public boolean onActionItemClicked(    ActionMode mode,    MenuItem item){
      if (mAdapter.getCheckedItemPositions().size() == 1) {
        return onFileActionChosen(item.getItemId(),mAdapter.getCheckedItemPositions().get(0));
      }
 else       if (mAdapter.getCheckedItemPositions().size() > 1) {
        return false;
      }
      return false;
    }
    @Override public void onDestroyActionMode(    ActionMode mode){
      mAdapter.removeSelection();
    }
  }
);
}
