{
  int status=-1;
  PutMethod put=null;
  FileChannel channel=null;
  FileLock lock=null;
  RandomAccessFile raf=null;
  try {
    File file=new File(getLocalPath());
    raf=new RandomAccessFile(file,"rw");
    channel=raf.getChannel();
    lock=channel.tryLock();
    ChunkFromFileChannelRequestEntity entity=new ChunkFromFileChannelRequestEntity(channel,getMimeType(),CHUNK_SIZE);
    entity.addOnDatatransferProgressListeners(getDataTransferListeners());
    long offset=0;
    String uriPrefix=client.getBaseUri() + WebdavUtils.encodePath(getRemotePath()) + "-chunking-"+ Math.abs((new Random()).nextInt(9000) + 1000)+ "-";
    long chunkCount=(long)Math.ceil((double)file.length() / CHUNK_SIZE);
    for (int chunkIndex=0; chunkIndex < chunkCount; chunkIndex++, offset+=CHUNK_SIZE) {
      put=new PutMethod(uriPrefix + chunkCount + "-"+ chunkIndex);
      put.addRequestHeader(OC_CHUNKED_HEADER,OC_CHUNKED_HEADER);
      entity.setOffset(offset);
      put.setRequestEntity(entity);
      status=client.executeMethod(put);
      client.exhaustResponse(put.getResponseBodyAsStream());
      Log.d(TAG,"Upload of " + getLocalPath() + " to "+ getRemotePath()+ ", chunk index "+ chunkIndex+ ", count "+ chunkCount+ ", HTTP result status "+ status);
      if (!isSuccess(status))       break;
    }
  }
  finally {
    if (lock != null)     lock.release();
    if (channel != null)     channel.close();
    if (raf != null)     raf.close();
    if (put != null)     put.releaseConnection();
  }
  return status;
}
