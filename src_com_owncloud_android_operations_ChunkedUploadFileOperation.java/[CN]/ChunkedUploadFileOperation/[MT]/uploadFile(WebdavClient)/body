{
  int status=-1;
  PutMethod put=null;
  FileChannel channel=null;
  FileLock lock=null;
  try {
    File file=new File(getLocalPath());
    channel=new RandomAccessFile(file,"rw").getChannel();
    lock=channel.tryLock();
    ChunkFromFileChannelRequestEntity entity=new ChunkFromFileChannelRequestEntity(channel,getMimeType(),CHUNK_SIZE);
    entity.setOnDatatransferProgressListener(getDataTransferListener());
    long offset=0;
    String uriPrefix=client.getBaseUri() + WebdavUtils.encodePath(getRemotePath()) + "-chunking-"+ Math.abs((new Random()).nextInt())+ "-";
    long chunkCount=(long)Math.ceil((double)file.length() / CHUNK_SIZE);
    for (int chunkIndex=0; chunkIndex < chunkCount; chunkIndex++, offset+=CHUNK_SIZE) {
      put=new PutMethod(uriPrefix + chunkIndex + "-"+ chunkCount);
      put.addRequestHeader(OC_CHUNKED_HEADER,OC_CHUNKED_HEADER);
      entity.setOffset(offset);
      put.setRequestEntity(entity);
      status=client.executeMethod(put);
      client.exhaustResponse(put.getResponseBodyAsStream());
      if (!isSuccess(status))       break;
    }
  }
  finally {
    if (lock != null)     lock.release();
    if (channel != null)     channel.close();
    if (put != null)     put.releaseConnection();
  }
  return status;
}
