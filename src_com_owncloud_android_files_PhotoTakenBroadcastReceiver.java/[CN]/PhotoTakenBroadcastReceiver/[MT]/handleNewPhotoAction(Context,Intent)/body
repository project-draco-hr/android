{
  Account account=AccountUtils.getCurrentOwnCloudAccount(context);
  if (account == null) {
    Log.w(TAG,"No owncloud account found for instant upload, aborting");
    return;
  }
  Cursor c=context.getContentResolver().query(intent.getData(),CONTENT_PROJECTION,null,null,null);
  if (!c.moveToFirst()) {
    Log.e(TAG,"Couldn't resolve given uri!");
    return;
  }
  boolean iu_via_wifi=PreferenceManager.getDefaultSharedPreferences(context).getBoolean("instant_upload_on_wifi",false);
  boolean is_conn_via_wifi=false;
  if (iu_via_wifi) {
    ConnectivityManager cm=(ConnectivityManager)context.getSystemService(Context.CONNECTIVITY_SERVICE);
    if (cm != null && cm.getActiveNetworkInfo() != null && cm.getActiveNetworkInfo().getType() == ConnectivityManager.TYPE_WIFI && cm.getActiveNetworkInfo().getState() == State.CONNECTED)     is_conn_via_wifi=true;
  }
  String file_path=c.getString(c.getColumnIndex(Media.DATA));
  String file_name=c.getString(c.getColumnIndex(Media.DISPLAY_NAME));
  String mime_type=c.getString(c.getColumnIndex(Media.MIME_TYPE));
  c.close();
  if (!isOnline(context) || (iu_via_wifi && !is_conn_via_wifi)) {
    DbHandler db=new DbHandler(context);
    db.putFileForLater(file_path,account.name);
    db.close();
    return;
  }
  Intent i=new Intent(context,FileUploader.class);
  i.putExtra(FileUploader.KEY_ACCOUNT,account);
  i.putExtra(FileUploader.KEY_LOCAL_FILE,file_path);
  i.putExtra(FileUploader.KEY_REMOTE_FILE,INSTANT_UPLOAD_DIR + "/" + file_name);
  i.putExtra(FileUploader.KEY_UPLOAD_TYPE,FileUploader.UPLOAD_SINGLE_FILE);
  i.putExtra(FileUploader.KEY_MIME_TYPE,mime_type);
  i.putExtra(FileUploader.KEY_INSTANT_UPLOAD,true);
  context.startService(i);
}
