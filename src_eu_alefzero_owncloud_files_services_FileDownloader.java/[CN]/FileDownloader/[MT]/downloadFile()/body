{
  AccountManager am=(AccountManager)getSystemService(ACCOUNT_SERVICE);
  WebdavClient wdc=new WebdavClient(mAccount,getApplicationContext());
  String username=mAccount.name.split("@")[0];
  String password="";
  try {
    password=am.blockingGetAuthToken(mAccount,AccountAuthenticator.AUTH_TOKEN_TYPE,true);
  }
 catch (  Exception e) {
    e.printStackTrace();
    return;
  }
  wdc.setCredentials(username,password);
  wdc.allowSelfsignedCertificates();
  wdc.setDataTransferProgressListener(this);
  mNotification=new Notification(R.drawable.icon,"Downloading file",System.currentTimeMillis());
  mNotification.flags|=Notification.FLAG_ONGOING_EVENT;
  mNotification.contentView=new RemoteViews(getApplicationContext().getPackageName(),R.layout.progressbar_layout);
  mNotification.contentView.setProgressBar(R.id.status_progress,100,0,mTotalDownloadSize == -1);
  mNotification.contentView.setImageViewResource(R.id.status_icon,R.drawable.icon);
  mNotification.contentIntent=PendingIntent.getActivity(getApplicationContext(),0,new Intent(),PendingIntent.FLAG_UPDATE_CURRENT);
  mNotificationMngr.notify(1,mNotification);
  File tmpFile=new File(getTemporalPath() + mAccount.name + mFilePath);
  tmpFile.getParentFile().mkdirs();
  boolean download_result=false;
  File newFile=null;
  if (wdc.downloadFile(mRemotePath,tmpFile)) {
    newFile=new File(getSavePath() + mAccount.name + mFilePath);
    newFile.getParentFile().mkdirs();
    boolean moved=tmpFile.renameTo(newFile);
    if (moved) {
      ContentValues cv=new ContentValues();
      cv.put(ProviderTableMeta.FILE_STORAGE_PATH,newFile.getAbsolutePath());
      getContentResolver().update(ProviderTableMeta.CONTENT_URI,cv,ProviderTableMeta.FILE_NAME + "=? AND " + ProviderTableMeta.FILE_ACCOUNT_OWNER+ "=?",new String[]{mFilePath.substring(mFilePath.lastIndexOf('/') + 1),mAccount.name});
      download_result=true;
    }
  }
  if (!download_result) {
    tmpFile.delete();
  }
  mNotificationMngr.cancel(1);
  Intent end=new Intent(DOWNLOAD_FINISH_MESSAGE);
  end.putExtra(EXTRA_REMOTE_PATH,mRemotePath);
  end.putExtra(EXTRA_FILE_PATH,newFile.getAbsolutePath());
  end.putExtra(EXTRA_DOWNLOAD_RESULT,download_result);
  end.putExtra(ACCOUNT_NAME,mAccount.name);
  sendBroadcast(end);
  if (download_result) {
    Toast.makeText(this,R.string.downloader_download_succeed,Toast.LENGTH_SHORT).show();
  }
 else {
    Toast.makeText(this,R.string.downloader_download_failed,Toast.LENGTH_SHORT).show();
  }
}
